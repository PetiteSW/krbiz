import json
from collections.abc import Callable
from dataclasses import dataclass

import pandas as pd
from js import confirm
from order_settings import load_order_variables_from_local_storage
from pyscript import document, when, window

_DELIVERY_INFO_KEY_SETTING_LOCAL_STORAGE_KEY = "DELIVERY-INFO-KEYS"


@dataclass
class DeliveryInfoKey:
    unified_variable_name: str
    """Unified variable name. i.e. receipients_name"""
    delivery_info_header: str
    """Header of the delivery information. i.e. ÏàòÌïòÏù∏Î™Ö"""


@dataclass
class DeliveryInfoKeysRegistry:
    """Proxy to the local storage."""

    keys: tuple[DeliveryInfoKey, ...]

    def add_key(self, delivery_info_header: str, unified_variable_name: str) -> None:
        new_key = DeliveryInfoKey(
            delivery_info_header=delivery_info_header,
            unified_variable_name=unified_variable_name,
        )
        # Make sure same delivery info header does not exist.
        self.delete_key(delivery_info_header)
        self.keys = (new_key, *self.keys)
        self._save_to_local_storage()
        refresh_delivery_info_keys_table()

    def delete_key(self, delivery_info_header: str) -> None:
        self.keys = tuple(
            key for key in self.keys if key.delivery_info_header != delivery_info_header
        )
        self._save_to_local_storage()

    def _save_to_local_storage(self) -> None:
        self_as_dict = {
            key.delivery_info_header: key.unified_variable_name for key in self.keys
        }
        _update_delivery_info_keys_in_local_storage(self_as_dict)


def initialize_delivery_key_format() -> None:
    unified_variables = load_order_variables_from_local_storage()
    select_input = document.getElementById("unified-variable-key-selection")
    select_input.replaceChildren()
    for var in unified_variables.unified_header:
        new_opt = document.createElement('option')
        new_opt.value = var
        new_opt.innerHTML = var
        select_input.appendChild(new_opt)


def add_delivery_info_key(event=None) -> None:
    if event:
        event.preventDefault()  # Don't know why it is needed,
        # but otherwise it raises error in javascript layer.
        delivery_header_input = document.getElementById("delivery-info-header-key")
        delivery_header_val = delivery_header_input.value
        unified_variable_input = document.getElementById(
            "unified-variable-key-selection"
        )
        unified_variable_val = unified_variable_input.value
        key_registry = load_delivery_info_keys_from_local_storage()
        key_registry.add_key(delivery_header_val, unified_variable_val)
        window.console.log(
            f"New delivery info keys: {delivery_header_val} - {unified_variable_val}"
        )

        # Reset input fields.
        delivery_header_input.value = ""
        if unified_variable_input.children:
            first_child = next(iter(unified_variable_input.children))
            unified_variable_input.value = first_child.value


def _update_delivery_info_keys_in_local_storage(
    new_vars_to_header: dict[str, str],
) -> None:
    window.console.log("Updating delivery info keys in the local storage...")
    local_storage = window.localStorage
    if local_storage.getItem(_DELIVERY_INFO_KEY_SETTING_LOCAL_STORAGE_KEY) is not None:
        window.console.log("Overwriting the existing delivery info keys.")
    delivery_keys_str = json.dumps(new_vars_to_header, ensure_ascii=False)
    local_storage.setItem(
        _DELIVERY_INFO_KEY_SETTING_LOCAL_STORAGE_KEY, delivery_keys_str
    )


def _initialize_delivery_info_keys_in_local_storage() -> None:
    window.console.log("Initializing delivery info keys as defaults.")
    default_vars_to_header = {"ÏàòÌïòÏù∏Î™Ö": "receipients_name", "ÏÉÅÌíàÎ™Ö": "option_info"}
    _update_delivery_info_keys_in_local_storage(default_vars_to_header)


def load_delivery_info_keys_from_local_storage() -> DeliveryInfoKeysRegistry:
    local_storage = window.localStorage
    if local_storage.getItem(_DELIVERY_INFO_KEY_SETTING_LOCAL_STORAGE_KEY) is None:
        _initialize_delivery_info_keys_in_local_storage()
    else:
        window.console.log("Found the existing delivery keys.")
    try:
        order_variables_dict = json.loads(
            local_storage.getItem(_DELIVERY_INFO_KEY_SETTING_LOCAL_STORAGE_KEY)
        )
        window.console.log(str(order_variables_dict))
        return DeliveryInfoKeysRegistry(
            keys=tuple(
                DeliveryInfoKey(
                    unified_variable_name=unified_var,
                    delivery_info_header=delivery_header,
                )
                for delivery_header, unified_var in order_variables_dict.items()
            )
        )
    except Exception:
        window.console.log(
            "Error occurred while loading existing delivery info keys. "
            "Please reset the settings."
        )


def _make_button_id(delivery_header: str) -> str:
    return f"delivery-key-{delivery_header}-delete-button"


def _make_delete_button(delivery_header: str) -> str:
    button_id = _make_button_id(delivery_header)
    button_tag = (
        '<div class="little-button-box"><button type="button" class="delete-button" '
        + f'id="{button_id}" value="{delivery_header}">'
    )
    trash_icon = '<img src="trash_icon.png" alt="üóëÔ∏è" height=1em>'
    return f'{button_tag}{trash_icon}</button></div>'


def make_delete_button_event_listener(delivery_header: str) -> Callable:
    def _delete_it(_) -> None:
        if confirm("ÏÑ†ÌÉùÌïòÏã† Ïó¥ Ïù¥Î¶Ñ ÏßùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?") and confirm(
            "ÏßÑÏßú ÏßÄÏõåÏöî? ü§î"
        ):
            key_registry = load_delivery_info_keys_from_local_storage()
            key_registry.delete_key(delivery_header)
            window.console.log(f"Deleted {delivery_header}")
            refresh_delivery_info_keys_table()
        else:
            window.console.log(f"Canceled deleting {delivery_header}")

    return _delete_it


def refresh_delivery_info_keys_table(_=None) -> None:
    key_registry = load_delivery_info_keys_from_local_storage()
    rows = [
        '<tr>'
        f'<td class="short-column">{key.delivery_info_header}</td>'
        f'<td class="short-column">{key.unified_variable_name}</td>'
        f'<td class="short-column">{_make_delete_button(key.delivery_info_header)}</td>'
        '</tr>'
        for key in key_registry.keys
    ]
    table_str = f"""
        <table>
            <tr class="header-row">
                <td> Î∞∞ÏÜ°Ï†ïÎ≥¥ Ïó¥ Ïù¥Î¶Ñ </td>
                <td> ÌÜµÌï© Ïó¥ Ïù¥Î¶Ñ </td>
                <td> ÏÇ≠Ï†ú </td>
            </tr>
            {'\n'.join(rows)}
        </table>
    """
    viewer_box = document.getElementById("delivery-info-keys-viewer-box")
    viewer_box.replaceChildren()
    new_table = document.createElement('table')
    new_table.innerHTML = table_str
    viewer_box.appendChild(new_table)
    # Add delete button event listeners
    for key in key_registry.keys:
        button_id = _make_button_id(key.delivery_info_header)
        del_button = document.getElementById(button_id)
        when("click", del_button)(
            make_delete_button_event_listener(key.delivery_info_header)
        )


@dataclass
class DeliveryReportMapping:
    target: str  # Target column to be replaced.


@dataclass
class FromDeliveryConfirmation(DeliveryReportMapping):
    column: str  # Column from delivery confirmation that needs to be replaced.


@dataclass
class FromOriginalOrderFile(DeliveryReportMapping):
    column: str  # Column from order file that needs to be replaced with.


@dataclass
class HardcodedColumn(DeliveryReportMapping):
    value: str  # Hardcoded value for a column.


@dataclass
class _PlatformDeliveryReportSetting:
    headers: pd.DataFrame  # pandas data frame that only has column names.
    # The order is very important.
    mappings: dict[str, DeliveryReportMapping]
    export_sheet_name: str | None = None
    """Sheet name is important for some platforms.

    i.e. Naver requires the excel sheet name to be ``Î∞úÏÜ°Ï≤òÎ¶¨``.
    """

    def render(
        self, order_row: pd.Series, delivery_row: pd.Series | None
    ) -> pd.DataFrame:
        base = self.headers.copy(deep=True)
        for col in base.columns:
            mapping = self.mappings.get(
                col,
                FromOriginalOrderFile(target=col, column=col),  # Always fall back
            )
            window.console.log(str(mapping))
            # Parse the value based on the mapping setting.
            if isinstance(mapping, FromOriginalOrderFile):
                value = order_row.get(
                    mapping.column, default=""
                )  # Leave it empty if not found.
            elif isinstance(mapping, FromDeliveryConfirmation) and (
                delivery_row is not None
            ):
                value = delivery_row.get(mapping.column, default="")
            elif isinstance(mapping, HardcodedColumn):
                value = mapping.value
            else:
                value = ""

            # Render - one row
            base[col] = [value]
        return base


def _load_excel_file_as_platform_report_setting(
    file_name,
) -> _PlatformDeliveryReportSetting:
    from excel_helpers import load_excel

    df = load_excel(file_name, nrows=3)
    mappings = {}
    for i_row, row in df.iterrows():
        # 1st row is rendered from delivery confirmation
        if i_row == 0:
            for col in df.columns:
                setting_value = row[col]
                if setting_value is not None and setting_value != "":
                    mappings[col] = FromDeliveryConfirmation(
                        target=col, column=setting_value
                    )
        # 2nd row is rendered hard-coded
        elif i_row == 1:
            for col in df.columns:
                setting_value = row[col]
                if setting_value is not None and setting_value != "":
                    mappings[col] = HardcodedColumn(target=col, value=setting_value)
        # 3rd row is rendered from original file
        elif i_row == 2:
            for col in df.columns:
                setting_value = row[col]
                if setting_value is not None and setting_value != "":
                    mappings[col] = FromOriginalOrderFile(
                        target=col, column=setting_value
                    )
    for col in df.columns:
        if col not in mappings:
            mappings[col] = FromOriginalOrderFile(target=col, column=col)

    return _PlatformDeliveryReportSetting(
        headers=pd.DataFrame(columns=df.columns),
        mappings=mappings,
        # TODO: Pass the name of the sheet to ``export_sheet_name``
    )


_delivery_report_registry = {
    'Naver': _PlatformDeliveryReportSetting(
        headers=pd.DataFrame(
            columns=['ÏÉÅÌíàÏ£ºÎ¨∏Î≤àÌò∏', 'Î∞∞ÏÜ°Î∞©Î≤ï', 'ÌÉùÎ∞∞ÏÇ¨', 'ÏÜ°Ïû•Î≤àÌò∏', 'Ïù¥Î¶Ñ', 'Ï£ºÏÜå']
        ),
        mappings={
            'ÏÉÅÌíàÏ£ºÎ¨∏Î≤àÌò∏': FromOriginalOrderFile(
                'ÏÉÅÌíàÏ£ºÎ¨∏Î≤àÌò∏', column='ÏÉÅÌíàÏ£ºÎ¨∏Î≤àÌò∏'
            ),
            'Î∞∞ÏÜ°Î∞©Î≤ï': HardcodedColumn('Î∞∞ÏÜ°Î∞©Î≤ï', value='ÌÉùÎ∞∞'),
            'ÌÉùÎ∞∞ÏÇ¨': HardcodedColumn('ÌÉùÎ∞∞ÏÇ¨', value='Î°ØÎç∞ÌÉùÎ∞∞'),
            'ÏÜ°Ïû•Î≤àÌò∏': FromDeliveryConfirmation('ÏÜ°Ïû•Î≤àÌò∏', column='Ïö¥ÏÜ°Ïû•Î≤àÌò∏'),
            'Ïù¥Î¶Ñ': FromOriginalOrderFile('Ïù¥Î¶Ñ', column='ÏàòÏ∑®Ïù∏Î™Ö'),
            'Ï£ºÏÜå': FromDeliveryConfirmation('Ï£ºÏÜå', column='ÏàòÌïòÏù∏Í∏∞Î≥∏Ï£ºÏÜå'),
        },
        export_sheet_name="Î∞úÏÜ°Ï≤òÎ¶¨",
    ),
    'Gmarket': _PlatformDeliveryReportSetting(
        headers=pd.DataFrame(
            columns=['Í≥ÑÏ†ï', 'Ï£ºÎ¨∏Î≤àÌò∏', 'ÌÉùÎ∞∞ÏÇ¨', 'ÏÜ°Ïû•Î≤àÌò∏', 'ÏàòÏ∑®Ïù∏Î™Ö'],
        ),
        mappings={
            'Í≥ÑÏ†ï': FromOriginalOrderFile(target='Í≥ÑÏ†ï', column='ÌåêÎß§ÏïÑÏù¥Îîî'),
            'Ï£ºÎ¨∏Î≤àÌò∏': FromOriginalOrderFile(target='Ï£ºÎ¨∏Î≤àÌò∏', column='Ï£ºÎ¨∏Î≤àÌò∏'),
            'ÌÉùÎ∞∞ÏÇ¨': HardcodedColumn('ÌÉùÎ∞∞ÏÇ¨', value='Î°ØÎç∞ÌÉùÎ∞∞'),
            'ÏÜ°Ïû•Î≤àÌò∏': FromDeliveryConfirmation('ÏÜ°Ïû•Î≤àÌò∏', column='Ïö¥ÏÜ°Ïû•Î≤àÌò∏'),
            'ÏàòÏ∑®Ïù∏Î™Ö': FromOriginalOrderFile('Ïù¥Î¶Ñ', column='ÏàòÎ†πÏù∏Î™Ö'),
        },
    ),
    'Coupang': _load_excel_file_as_platform_report_setting(
        '_resources/_default_coupang_delivery_report_form.xlsx'
    ),
}
